# Lefthook Configuration
# Git hooks manager - runs security checks on commits and pushes
# Docs: https://github.com/evilmartians/lefthook

# Global settings
min_version: 1.5.0
colors: true
no_tty: false

# Pre-commit hook - fast checks before commit
pre-commit:
  parallel: true

  commands:
    # Check for secrets in staged files
    gitleaks-staged:
      tags: security
      run: gitleaks protect --staged --redact --verbose --no-banner
      skip:
        - merge
        - rebase

    # Scan staged files with trufflehog
    trufflehog-git-staged:
      tags: security
      run: trufflehog git file://. --since-commit HEAD --only-verified --fail --json 2>&1 | jq -r '.msg'
      skip:
        - merge
        - rebase

    # Prevent committing to main/master directly
    prevent-main-commit:
      tags: branch-protection
      run: |
        branch=$(git rev-parse --abbrev-ref HEAD)
        if [ "$branch" = "main" ] || [ "$branch" = "master" ]; then
          echo "‚ùå Direct commits to main/master are not recommended!"
          echo "   Create a feature branch instead:"
          echo "   git checkout -b feature/your-feature-name"
        fi
      skip:
        - merge
        - rebase

    # Check for protected environment tag patterns in commits (pre-push hook handles this better)
    check-environment-tags:
      tags: tag-protection
      run: |
        # Check if we're pushing environment tags
        for ref in $@; do
          case "$ref" in
            refs/tags/*production|refs/tags/*staging|refs/tags/*canary|refs/tags/*sandbox|refs/tags/*performance)
              echo "‚ùå Environment tag detected: $ref"
              echo "   Environment tags must be created via Tag Assignment workflow"
              exit 1
              ;;
          esac
        done
      skip:
        - merge
        - rebase

    # Validate GitHub Actions workflows
    validate-workflows:
      tags: validation
      glob: ".github/workflows/*.{yml,yaml}"
      run: |
        echo "Validating GitHub Actions workflows..."
        WORKFLOWS=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.github/workflows/.*\.ya?ml$' || true)
        if [ -n "$WORKFLOWS" ]; then
          echo "$WORKFLOWS" | xargs action-validator
        else
          echo "‚úì No workflow files to validate"
        fi
      skip:
        - merge
        - rebase

# Pre-push hook - more thorough checks before push
pre-push:
  parallel: false

  commands:
    # Validate all GitHub Actions workflows
    validate-all-workflows:
      tags: validation
      run: |
        echo "Validating all GitHub Actions workflows..."
        find .github/workflows -type f -name "*.yml" | xargs action-validator --verbose 2>/dev/null || true

    # Full gitleaks scan of commits being pushed
    gitleaks-push:
      tags: security
      run: gitleaks protect --redact --verbose --no-banner

    # Full trufflehog scan
    trufflehog-push:
      tags: security
      run: |
        trufflehog git file://. --since-commit "$(git rev-parse @{u} 2>/dev/null || echo '')" --only-verified --fail --json 2>&1 | jq -r '.msg'

    # Protected environment tag protection
    protect-environment-tags:
      tags: tag-protection
      run: |
        if [ -f "scripts/hooks/pre-push-tag-protection.sh" ]; then
          echo "Checking for protected environment tags..."
          ./scripts/hooks/pre-push-tag-protection.sh
        else
          echo "‚ö†Ô∏è  Tag protection script not found at scripts/hooks/pre-push-tag-protection.sh"
        fi

    # Shell script formatting check
    check-shell-format:
      tags: format
      run: |
        echo "Checking bash script formatting..."
        if command -v shfmt >/dev/null 2>&1; then
          find scripts/ -name '*.sh' -exec shfmt -d -i 2 -ci -sr {} + || true
        else
          echo "‚ö†Ô∏è  shfmt not available, skipping format check"
        fi

# Commit-msg hook - enforce conventional commits
commit-msg:
  commands:
    conventional-commit:
      tags: commit-format
      run: |
        # Check if file path is provided, if not use standard git commit message file
        COMMIT_MSG_FILE="${1:-.git/COMMIT_EDITMSG}"
        if [ ! -f "$COMMIT_MSG_FILE" ]; then
          # Try to find the commit message file in common locations
          for file in ".git/COMMIT_EDITMSG" ".git/COMMITMSG"; do
            if [ -f "$file" ]; then
              COMMIT_MSG_FILE="$file"
              break
            fi
          done
        fi

        # If still no file found, exit with error
        if [ ! -f "$COMMIT_MSG_FILE" ]; then
          echo "‚ùå Commit message file not found!"
          echo "   Expected file: ${1:-.git/COMMIT_EDITMSG}"
          exit 1
        fi

        # Run the validation script
        ./scripts/hooks/pre-commit-message-check.sh "$COMMIT_MSG_FILE"

# Post-checkout hook - remind about mise
post-checkout:
  commands:
    mise-reminder:
      run: |
        if [ ! -f ".secrets/mise-age.txt" ]; then
          echo "üí° Tip: Run 'mise run generate-age-key' to set up secret management"
        fi
      skip:
        - merge
        - rebase

# Skip hooks for specific scenarios
skip_output:
  - meta
  - summary

# Remote configuration (optional)
# Allows sharing hooks via git
# remotes:
#   - git_url: https://github.com/your-org/shared-hooks.git
#     ref: main
#     configs:
#       - lefthook.yml
