name: Pre-Release Pipeline

on:
  pull_request:
    branches:
      - main
      - develop
  push:
    branches:
      - develop
      - 'feature/**'
      - 'fix/**'

env:
  # CI Feature Flags - Set these in GitHub Variables to activate jobs
  # Leave unset to skip jobs without failure
  ENABLE_COMPILE: ${{ vars.ENABLE_COMPILE || 'false' }}
  ENABLE_LINT: ${{ vars.ENABLE_LINT || 'false' }}
  ENABLE_UNIT_TESTS: ${{ vars.ENABLE_UNIT_TESTS || 'false' }}
  ENABLE_INTEGRATION_TESTS: ${{ vars.ENABLE_INTEGRATION_TESTS || 'false' }}
  ENABLE_E2E_TESTS: ${{ vars.ENABLE_E2E_TESTS || 'false' }}
  ENABLE_BUNDLE: ${{ vars.ENABLE_BUNDLE || 'false' }}
  ENABLE_SECURITY_SCAN: ${{ vars.ENABLE_SECURITY_SCAN || 'false' }}

jobs:
  setup:
    name: Setup and Install Dependencies
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup environment
        run: |
          chmod +x scripts/setup/*.sh
          ./scripts/setup/install-tools.sh

      - name: Install dependencies
        run: ./scripts/setup/install-dependencies.sh

      - name: Cache dependencies
        uses: actions/cache@v3
        with:
          path: |
            node_modules
            ~/.cache
            .cache
          key: ${{ runner.os }}-deps-${{ hashFiles('**/package*.json', '**/yarn.lock', '**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-deps-

  compile:
    name: Compile/Build
    runs-on: ubuntu-latest
    needs: setup
    if: ${{ vars.ENABLE_COMPILE == 'true' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Restore dependencies cache
        uses: actions/cache@v3
        with:
          path: |
            node_modules
            ~/.cache
            .cache
          key: ${{ runner.os }}-deps-${{ hashFiles('**/package*.json', '**/yarn.lock', '**/pnpm-lock.yaml') }}

      - name: Run compile
        run: |
          chmod +x scripts/build/*.sh
          ./scripts/build/compile.sh

      - name: Upload build artifacts
        uses: actions/upload-artifact@v3
        with:
          name: build-output
          path: |
            dist/
            build/
            out/
          retention-days: 7

  lint:
    name: Lint Code
    runs-on: ubuntu-latest
    needs: setup
    if: ${{ vars.ENABLE_LINT == 'true' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Restore dependencies cache
        uses: actions/cache@v3
        with:
          path: |
            node_modules
            ~/.cache
            .cache
          key: ${{ runner.os }}-deps-${{ hashFiles('**/package*.json', '**/yarn.lock', '**/pnpm-lock.yaml') }}

      - name: Run linter
        run: |
          chmod +x scripts/build/*.sh
          ./scripts/build/lint.sh

  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: setup
    if: ${{ vars.ENABLE_UNIT_TESTS == 'true' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Restore dependencies cache
        uses: actions/cache@v3
        with:
          path: |
            node_modules
            ~/.cache
            .cache
          key: ${{ runner.os }}-deps-${{ hashFiles('**/package*.json', '**/yarn.lock', '**/pnpm-lock.yaml') }}

      - name: Run unit tests
        run: |
          chmod +x scripts/test/*.sh
          ./scripts/test/unit.sh

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: unit-test-results
          path: |
            coverage/
            test-results/
          retention-days: 7

  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [setup, compile]
    if: ${{ vars.ENABLE_INTEGRATION_TESTS == 'true' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Restore dependencies cache
        uses: actions/cache@v3
        with:
          path: |
            node_modules
            ~/.cache
            .cache
          key: ${{ runner.os }}-deps-${{ hashFiles('**/package*.json', '**/yarn.lock', '**/pnpm-lock.yaml') }}

      - name: Download build artifacts
        if: ${{ vars.ENABLE_COMPILE == 'true' }}
        uses: actions/download-artifact@v3
        with:
          name: build-output

      - name: Run integration tests
        run: |
          chmod +x scripts/test/*.sh
          ./scripts/test/integration.sh

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: integration-test-results
          path: |
            coverage/
            test-results/
          retention-days: 7

  e2e-tests:
    name: End-to-End Tests
    runs-on: ubuntu-latest
    needs: [setup, compile]
    if: ${{ vars.ENABLE_E2E_TESTS == 'true' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Restore dependencies cache
        uses: actions/cache@v3
        with:
          path: |
            node_modules
            ~/.cache
            .cache
          key: ${{ runner.os }}-deps-${{ hashFiles('**/package*.json', '**/yarn.lock', '**/pnpm-lock.yaml') }}

      - name: Download build artifacts
        if: ${{ vars.ENABLE_COMPILE == 'true' }}
        uses: actions/download-artifact@v3
        with:
          name: build-output

      - name: Run E2E tests
        run: |
          chmod +x scripts/test/*.sh
          ./scripts/test/e2e.sh

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: e2e-test-results
          path: |
            coverage/
            test-results/
            screenshots/
            videos/
          retention-days: 7

  security-scan:
    name: Security Vulnerability Scan
    runs-on: ubuntu-latest
    needs: setup
    if: ${{ vars.ENABLE_SECURITY_SCAN == 'true' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run vulnerability scan
        run: |
          chmod +x scripts/build/*.sh
          ./scripts/build/security-scan.sh

  bundle:
    name: Bundle and Package
    runs-on: ubuntu-latest
    needs: [compile, lint, unit-tests]
    if: |
      always() &&
      (needs.compile.result == 'success' || needs.compile.result == 'skipped') &&
      (needs.lint.result == 'success' || needs.lint.result == 'skipped') &&
      (needs.unit-tests.result == 'success' || needs.unit-tests.result == 'skipped') &&
      vars.ENABLE_BUNDLE == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Restore dependencies cache
        uses: actions/cache@v3
        with:
          path: |
            node_modules
            ~/.cache
            .cache
          key: ${{ runner.os }}-deps-${{ hashFiles('**/package*.json', '**/yarn.lock', '**/pnpm-lock.yaml') }}

      - name: Download build artifacts
        if: ${{ vars.ENABLE_COMPILE == 'true' }}
        uses: actions/download-artifact@v3
        with:
          name: build-output

      - name: Create bundle/package
        run: |
          chmod +x scripts/build/*.sh
          ./scripts/build/bundle.sh

      - name: Upload bundle artifacts
        uses: actions/upload-artifact@v3
        with:
          name: bundle-output
          path: |
            *.tgz
            *.tar.gz
            *.zip
            dist/
          retention-days: 30

  summary:
    name: Pipeline Summary
    runs-on: ubuntu-latest
    needs: [setup, compile, lint, unit-tests, integration-tests, e2e-tests, security-scan, bundle]
    if: always()
    steps:
      - name: Check all job statuses
        run: |
          echo "## Pre-Release Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status | Enabled |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|---------|" >> $GITHUB_STEP_SUMMARY
          echo "| Setup | ${{ needs.setup.result }} | Always |" >> $GITHUB_STEP_SUMMARY
          echo "| Compile | ${{ needs.compile.result }} | ${{ vars.ENABLE_COMPILE || 'false' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Lint | ${{ needs.lint.result }} | ${{ vars.ENABLE_LINT || 'false' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Unit Tests | ${{ needs.unit-tests.result }} | ${{ vars.ENABLE_UNIT_TESTS || 'false' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Integration Tests | ${{ needs.integration-tests.result }} | ${{ vars.ENABLE_INTEGRATION_TESTS || 'false' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| E2E Tests | ${{ needs.e2e-tests.result }} | ${{ vars.ENABLE_E2E_TESTS || 'false' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security Scan | ${{ needs.security-scan.result }} | ${{ vars.ENABLE_SECURITY_SCAN || 'false' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Bundle | ${{ needs.bundle.result }} | ${{ vars.ENABLE_BUNDLE || 'false' }} |" >> $GITHUB_STEP_SUMMARY

      - name: Report failure
        if: |
          needs.setup.result == 'failure' ||
          needs.compile.result == 'failure' ||
          needs.lint.result == 'failure' ||
          needs.unit-tests.result == 'failure' ||
          needs.integration-tests.result == 'failure' ||
          needs.e2e-tests.result == 'failure' ||
          needs.security-scan.result == 'failure' ||
          needs.bundle.result == 'failure'
        run: |
          echo "::error::One or more pipeline jobs failed"
          exit 1

  notify:
    name: Send Notifications
    runs-on: ubuntu-latest
    needs: [summary]
    if: always() && vars.ENABLE_NOTIFICATIONS == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Determine pipeline status
        id: status
        run: |
          if [ "${{ needs.summary.result }}" == "failure" ]; then
            echo "status=failure" >> $GITHUB_OUTPUT
            echo "message=Pre-Release Pipeline Failed ❌" >> $GITHUB_OUTPUT
          elif [ "${{ needs.summary.result }}" == "success" ]; then
            echo "status=success" >> $GITHUB_OUTPUT
            echo "message=Pre-Release Pipeline Passed ✅" >> $GITHUB_OUTPUT
          else
            echo "status=warning" >> $GITHUB_OUTPUT
            echo "message=Pre-Release Pipeline Completed with Issues ⚠️" >> $GITHUB_OUTPUT
          fi

      - name: Send notification
        env:
          APPRISE_URLS: ${{ secrets.APPRISE_URLS }}
        run: |
          chmod +x scripts/setup/send-notification.sh
          ./scripts/setup/send-notification.sh \
            "Pre-Release Pipeline" \
            "${{ steps.status.outputs.message }}" \
            "${{ steps.status.outputs.status }}"
