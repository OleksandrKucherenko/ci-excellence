name: Pre-Release Pipeline

on:
  pull_request:
    branches:
      - main
      - develop
  push:
    branches:
      - develop
      - 'feature/**'
      - 'fix/**'

env:
  # CI Feature Flags - Set these in GitHub Variables to activate jobs
  # Leave unset to skip jobs without failure
  ENABLE_COMPILE: ${{ vars.ENABLE_COMPILE || 'false' }}
  ENABLE_LINT: ${{ vars.ENABLE_LINT || 'false' }}
  ENABLE_UNIT_TESTS: ${{ vars.ENABLE_UNIT_TESTS || 'false' }}
  ENABLE_INTEGRATION_TESTS: ${{ vars.ENABLE_INTEGRATION_TESTS || 'false' }}
  ENABLE_E2E_TESTS: ${{ vars.ENABLE_E2E_TESTS || 'false' }}
  ENABLE_BUNDLE: ${{ vars.ENABLE_BUNDLE || 'false' }}
  ENABLE_SECURITY_SCAN: ${{ vars.ENABLE_SECURITY_SCAN || 'false' }}

jobs:
  setup:
    name: Setup and Install Dependencies
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup environment and validate
        run: ./scripts/setup/00-setup-folders.sh

      - name: Install dependencies and tools
        run: mise run verify-tools

      - name: Cache dependencies
        uses: actions/cache@v3
        with:
          path: |
            node_modules
            ~/.cache
            .cache
          key: ${{ runner.os }}-deps-${{ hashFiles('**/package*.json', '**/yarn.lock', '**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-deps-

  compile:
    name: Compile/Build
    runs-on: ubuntu-latest
    needs: setup
    if: ${{ vars.ENABLE_COMPILE == 'true' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Restore dependencies cache
        uses: actions/cache@v3
        with:
          path: |
            node_modules
            ~/.cache
            .cache
          key: ${{ runner.os }}-deps-${{ hashFiles('**/package*.json', '**/yarn.lock', '**/pnpm-lock.yaml') }}

      - name: Run compile
        env:
          CI_TEST_MODE: "EXECUTE"
          PIPELINE_COMPILE_MODE: "${{ vars.COMPILE_MODE || 'EXECUTE' }}"
        run: ./scripts/build/10-ci-compile.sh

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-output
          path: |
            dist/
            build/
            out/
          retention-days: 7

  lint:
    name: Lint Code
    runs-on: ubuntu-latest
    needs: setup
    if: ${{ vars.ENABLE_LINT == 'true' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Restore dependencies cache
        uses: actions/cache@v3
        with:
          path: |
            node_modules
            ~/.cache
            .cache
          key: ${{ runner.os }}-deps-${{ hashFiles('**/package*.json', '**/yarn.lock', '**/pnpm-lock.yaml') }}

      - name: Run linter
        env:
          CI_TEST_MODE: "EXECUTE"
          PIPELINE_LINT_MODE: "${{ vars.LINT_MODE || 'EXECUTE' }}"
        run: ./scripts/build/20-ci-lint.sh

  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: setup
    if: ${{ vars.ENABLE_UNIT_TESTS == 'true' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Restore dependencies cache
        uses: actions/cache@v3
        with:
          path: |
            node_modules
            ~/.cache
            .cache
          key: ${{ runner.os }}-deps-${{ hashFiles('**/package*.json', '**/yarn.lock', '**/pnpm-lock.yaml') }}

      - name: Run unit tests
        env:
          CI_TEST_MODE: "EXECUTE"
          PIPELINE_UNIT_TESTS_MODE: "${{ vars.UNIT_TESTS_MODE || 'EXECUTE' }}"
        run: ./scripts/test/10-ci-unit-tests.sh

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: unit-test-results
          path: |
            coverage/
            test-results/
          retention-days: 7

  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [setup, compile]
    if: ${{ vars.ENABLE_INTEGRATION_TESTS == 'true' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Restore dependencies cache
        uses: actions/cache@v3
        with:
          path: |
            node_modules
            ~/.cache
            .cache
          key: ${{ runner.os }}-deps-${{ hashFiles('**/package*.json', '**/yarn.lock', '**/pnpm-lock.yaml') }}

      - name: Download build artifacts
        if: ${{ vars.ENABLE_COMPILE == 'true' }}
        uses: actions/download-artifact@v4
        with:
          name: build-output

      - name: Run integration tests
        env:
          CI_TEST_MODE: "EXECUTE"
          PIPELINE_INTEGRATION_TESTS_MODE: "${{ vars.INTEGRATION_TESTS_MODE || 'EXECUTE' }}"
        run: ./scripts/test/20-ci-integration-tests.sh

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: integration-test-results
          path: |
            coverage/
            test-results/
          retention-days: 7

  e2e-tests:
    name: End-to-End Tests
    runs-on: ubuntu-latest
    needs: [setup, compile]
    if: ${{ vars.ENABLE_E2E_TESTS == 'true' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Restore dependencies cache
        uses: actions/cache@v3
        with:
          path: |
            node_modules
            ~/.cache
            .cache
          key: ${{ runner.os }}-deps-${{ hashFiles('**/package*.json', '**/yarn.lock', '**/pnpm-lock.yaml') }}

      - name: Download build artifacts
        if: ${{ vars.ENABLE_COMPILE == 'true' }}
        uses: actions/download-artifact@v4
        with:
          name: build-output

      - name: Run E2E tests
        env:
          CI_TEST_MODE: "EXECUTE"
          PIPELINE_E2E_TESTS_MODE: "${{ vars.E2E_TESTS_MODE || 'EXECUTE' }}"
        run: ./scripts/test/30-ci-e2e-tests.sh

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-test-results
          path: |
            coverage/
            test-results/
            screenshots/
            videos/
          retention-days: 7

  security-scan:
    name: Security Vulnerability Scan
    runs-on: ubuntu-latest
    needs: setup
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for trufflehog to scan

      - name: Setup mise and install tools
        run: mise run verify-tools

      - name: Run vulnerability scan
        env:
          CI_TEST_MODE: "EXECUTE"
          PIPELINE_SECURITY_SCAN_MODE: "${{ vars.SECURITY_SCAN_MODE || 'EXECUTE' }}"
        run: ./scripts/build/30-ci-security-scan.sh staging high all

      - name: Upload security reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-reports
          path: |
            gitleaks-report.json
            trufflehog-report.json
            security-results.sarif
          retention-days: 30

  enhanced-security-gates:
    name: Enhanced Security Gates
    runs-on: ubuntu-latest
    needs: [setup, compile, lint, unit-tests]
    if: |
      always() &&
      (needs.setup.result == 'success') &&
      (needs.compile.result == 'success' || needs.compile.result == 'skipped') &&
      (needs.lint.result == 'success' || needs.lint.result == 'skipped') &&
      (needs.unit-tests.result == 'success' || needs.unit-tests.result == 'skipped') &&
      vars.ENABLE_ENHANCED_SECURITY == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup mise and install tools
        run: mise run verify-tools

      - name: Run enhanced security and quality gates
        env:
          CI_TEST_MODE: "EXECUTE"
          SECURITY_GATES_MODE: "${{ vars.SECURITY_GATES_MODE || 'EXECUTE' }}"
          WEBHOOK_AUTH_TOKEN: "${{ secrets.WEBHOOK_AUTH_TOKEN }}"
          WEBHOOK_URL: "${{ vars.WEBHOOK_URL }}"
          QUALITY_THRESHOLD_SCORE: "${{ vars.QUALITY_THRESHOLD_SCORE || '80' }}"
          CRITICAL_VULNERABILITY_LIMIT: "${{ vars.CRITICAL_VULNERABILITY_LIMIT || '0' }}"
          HIGH_VULNERABILITY_LIMIT: "${{ vars.HIGH_VULNERABILITY_LIMIT || '5' }}"
          REQUIRE_GDPR_COMPLIANCE: "${{ vars.REQUIRE_GDPR_COMPLIANCE || 'true' }}"
          REQUIRE_SOC2_COMPLIANCE: "${{ vars.REQUIRE_SOC2_COMPLIANCE || 'false' }}"
          REQUIRE_HIPAA_COMPLIANCE: "${{ vars.REQUIRE_HIPAA_COMPLIANCE || 'false' }}"
        run: |
          ./scripts/ci/security/02-ci-enhanced-security-gates.sh high all

      - name: Validate cloud region mapping
        env:
          CLOUD_PROVIDER: "${{ vars.CLOUD_PROVIDER || 'aws' }}"
          REGION_CODE: "${{ vars.CLOUD_REGION || 'us-east-1' }}"
          REQUIRE_GDPR_COMPLIANCE: "${{ vars.REQUIRE_GDPR_COMPLIANCE || 'true' }}"
        run: |
          ./scripts/ci/security/03-ci-cloud-region-mapping.sh "$CLOUD_PROVIDER" "$REGION_CODE"

      - name: Test webhook authentication
        if: vars.WEBHOOK_URL != ''
        env:
          WEBHOOK_AUTH_TOKEN: "${{ secrets.WEBHOOK_AUTH_TOKEN }}"
          WEBHOOK_URL: "${{ vars.WEBHOOK_URL }}"
        run: |
          ./scripts/ci/security/04-ci-webhook-authentication.sh test "$WEBHOOK_URL" "test_payload"

      - name: Upload security gates reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: enhanced-security-reports
          path: |
            security-gates-report.md
            region-mapping-output.txt
            webhook-authentication-results.json
          retention-days: 30

  bundle:
    name: Bundle and Package
    runs-on: ubuntu-latest
    needs: [compile, lint, unit-tests, enhanced-security-gates]
    if: |
      always() &&
      (needs.compile.result == 'success' || needs.compile.result == 'skipped') &&
      (needs.lint.result == 'success' || needs.lint.result == 'skipped') &&
      (needs.unit-tests.result == 'success' || needs.unit-tests.result == 'skipped') &&
      (needs.enhanced-security-gates.result == 'success' || needs.enhanced-security-gates.result == 'skipped') &&
      vars.ENABLE_BUNDLE == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Restore dependencies cache
        uses: actions/cache@v3
        with:
          path: |
            node_modules
            ~/.cache
            .cache
          key: ${{ runner.os }}-deps-${{ hashFiles('**/package*.json', '**/yarn.lock', '**/pnpm-lock.yaml') }}

      - name: Download build artifacts
        if: ${{ vars.ENABLE_COMPILE == 'true' }}
        uses: actions/download-artifact@v4
        with:
          name: build-output

      - name: Create bundle/package
        run: ./scripts/ci/build/ci-04-bundle.sh

      - name: Upload bundle artifacts
        uses: actions/upload-artifact@v4
        with:
          name: bundle-output
          path: |
            *.tgz
            *.tar.gz
            *.zip
            dist/
          retention-days: 30

  summary:
    name: Pipeline Summary
    runs-on: ubuntu-latest
    needs: [setup, compile, lint, unit-tests, integration-tests, e2e-tests, security-scan, enhanced-security-gates, bundle]
    if: always()
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Generate comprehensive summary with action links
        env:
          # Pipeline results for summary generation
          SETUP_RESULT: "${{ needs.setup.result }}"
          COMPILE_RESULT: "${{ needs.compile.result }}"
          LINT_RESULT: "${{ needs.lint.result }}"
          UNIT_TESTS_RESULT: "${{ needs.unit-tests.result }}"
          INTEGRATION_TESTS_RESULT: "${{ needs.integration-tests.result }}"
          E2E_TESTS_RESULT: "${{ needs.e2e-tests.result }}"
          SECURITY_SCAN_RESULT: "${{ needs.security-scan.result }}"
          ENHANCED_SECURITY_GATES_RESULT: "${{ needs.enhanced-security-gates.result }}"
          BUNDLE_RESULT: "${{ needs.bundle.result }}"

          # GitHub context for action links
          GITHUB_SERVER_URL: ${{ github.server_url }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_RUN_ID: ${{ github.run_id }}
          GITHUB_SHA: ${{ github.sha }}
          GITHUB_REF_NAME: ${{ github.ref_name }}

          # Action link configuration
          PIPELINE_TYPE: "pre-release"
          ENABLE_ACTION_LINKS: "true"
        run: |
          ./scripts/ci/reporting/15-ci-generate-pre-release-summary.sh

      - name: Upload pipeline summary
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: pre-release-summary
          path: summaries/
          retention-days: 30

  notify:
    name: Send Notifications
    runs-on: ubuntu-latest
    needs: [summary]
    if: always()
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check if notifications enabled
        id: check_notify
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          APPRISE_URLS: ${{ secrets.APPRISE_URLS }}
          ENABLE_NOTIFICATIONS: ${{ vars.ENABLE_NOTIFICATIONS }}
        run: |
          chmod +x scripts/ci/notification/check-notifications-enabled.sh
          ./scripts/ci/notification/check-notifications-enabled.sh

      - name: Determine pipeline status
        if: steps.check_notify.outputs.enabled == 'true'
        id: status
        env:
          GITHUB_RUN_NUMBER: ${{ github.run_number }}
          GITHUB_REF_NAME: ${{ github.ref_name }}
          GITHUB_SHA: ${{ github.sha }}
          GITHUB_ACTOR: ${{ github.actor }}
          GITHUB_SERVER_URL: ${{ github.server_url }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_RUN_ID: ${{ github.run_id }}
        run: ./scripts/ci/notification/ci-02-determine-status.sh "${{ needs.summary.result }}"

      - name: Send notification
        if: steps.check_notify.outputs.enabled == 'true'
        env:
          APPRISE_URLS: ${{ steps.check_notify.outputs.apprise_urls }}
        run: |
          chmod +x scripts/setup/send-notification.sh
          ./scripts/setup/send-notification.sh \
            "Pre-Release Pipeline" \
            "${{ steps.status.outputs.message }}" \
            "${{ steps.status.outputs.status }}"
