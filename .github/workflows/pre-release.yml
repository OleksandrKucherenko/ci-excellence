name: Pre-Release Pipeline

on:
  pull_request:
    branches:
      - main
      - develop
  push:
    branches:
      - develop
      - 'feature/**'
      - 'fix/**'

env:
  # CI Feature Flags - Set these in GitHub Variables to activate jobs
  # Leave unset to skip jobs without failure
  ENABLE_COMPILE: ${{ vars.ENABLE_COMPILE || 'false' }}
  ENABLE_LINT: ${{ vars.ENABLE_LINT || 'false' }}
  ENABLE_UNIT_TESTS: ${{ vars.ENABLE_UNIT_TESTS || 'false' }}
  ENABLE_INTEGRATION_TESTS: ${{ vars.ENABLE_INTEGRATION_TESTS || 'false' }}
  ENABLE_E2E_TESTS: ${{ vars.ENABLE_E2E_TESTS || 'false' }}
  ENABLE_BUNDLE: ${{ vars.ENABLE_BUNDLE || 'false' }}
  ENABLE_SECURITY_SCAN: ${{ vars.ENABLE_SECURITY_SCAN || 'false' }}

jobs:
  setup:
    name: Setup and Install Dependencies
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup environment
        run: ./scripts/ci/setup/ci-01-install-tools.sh
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Install dependencies
        run: ./scripts/ci/setup/ci-02-install-dependencies.sh

      - name: Cache dependencies
        uses: actions/cache@v3
        with:
          path: |
            node_modules
            ~/.cache
            .cache
          key: ${{ runner.os }}-deps-${{ hashFiles('**/package*.json', '**/yarn.lock', '**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-deps-

  compile:
    name: Compile/Build
    runs-on: ubuntu-latest
    needs: setup
    if: ${{ vars.ENABLE_COMPILE == 'true' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Restore dependencies cache
        uses: actions/cache@v3
        with:
          path: |
            node_modules
            ~/.cache
            .cache
          key: ${{ runner.os }}-deps-${{ hashFiles('**/package*.json', '**/yarn.lock', '**/pnpm-lock.yaml') }}

      - name: Run compile
        run: ./scripts/ci/build/ci-01-compile.sh

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-output
          path: |
            dist/
            build/
            out/
          retention-days: 7

  lint:
    name: Lint Code
    runs-on: ubuntu-latest
    needs: setup
    if: ${{ vars.ENABLE_LINT == 'true' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Restore dependencies cache
        uses: actions/cache@v3
        with:
          path: |
            node_modules
            ~/.cache
            .cache
          key: ${{ runner.os }}-deps-${{ hashFiles('**/package*.json', '**/yarn.lock', '**/pnpm-lock.yaml') }}

      - name: Run linter
        run: ./scripts/ci/build/ci-02-lint.sh

  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: setup
    if: ${{ vars.ENABLE_UNIT_TESTS == 'true' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Restore dependencies cache
        uses: actions/cache@v3
        with:
          path: |
            node_modules
            ~/.cache
            .cache
          key: ${{ runner.os }}-deps-${{ hashFiles('**/package*.json', '**/yarn.lock', '**/pnpm-lock.yaml') }}

      - name: Run unit tests
        run: ./scripts/ci/test/ci-01-unit-tests.sh

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: unit-test-results
          path: |
            coverage/
            test-results/
          retention-days: 7

  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [setup, compile]
    if: ${{ vars.ENABLE_INTEGRATION_TESTS == 'true' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Restore dependencies cache
        uses: actions/cache@v3
        with:
          path: |
            node_modules
            ~/.cache
            .cache
          key: ${{ runner.os }}-deps-${{ hashFiles('**/package*.json', '**/yarn.lock', '**/pnpm-lock.yaml') }}

      - name: Download build artifacts
        if: ${{ vars.ENABLE_COMPILE == 'true' }}
        uses: actions/download-artifact@v4
        with:
          name: build-output

      - name: Run integration tests
        run: ./scripts/ci/test/ci-02-integration-tests.sh

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: integration-test-results
          path: |
            coverage/
            test-results/
          retention-days: 7

  e2e-tests:
    name: End-to-End Tests
    runs-on: ubuntu-latest
    needs: [setup, compile]
    if: ${{ vars.ENABLE_E2E_TESTS == 'true' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Restore dependencies cache
        uses: actions/cache@v3
        with:
          path: |
            node_modules
            ~/.cache
            .cache
          key: ${{ runner.os }}-deps-${{ hashFiles('**/package*.json', '**/yarn.lock', '**/pnpm-lock.yaml') }}

      - name: Download build artifacts
        if: ${{ vars.ENABLE_COMPILE == 'true' }}
        uses: actions/download-artifact@v4
        with:
          name: build-output

      - name: Run E2E tests
        run: ./scripts/ci/test/ci-03-e2e-tests.sh

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-test-results
          path: |
            coverage/
            test-results/
            screenshots/
            videos/
          retention-days: 7

  security-scan:
    name: Security Vulnerability Scan
    runs-on: ubuntu-latest
    needs: setup
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for trufflehog to scan

      - name: Setup mise and install tools
        run: ./scripts/ci/setup/ci-01-install-tools.sh
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Run vulnerability scan
        run: ./scripts/ci/build/ci-03-security-scan.sh

      - name: Upload security reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-reports
          path: |
            gitleaks-report.json
            trufflehog-report.json
            security-results.sarif
          retention-days: 30

  bundle:
    name: Bundle and Package
    runs-on: ubuntu-latest
    needs: [compile, lint, unit-tests]
    if: |
      always() &&
      (needs.compile.result == 'success' || needs.compile.result == 'skipped') &&
      (needs.lint.result == 'success' || needs.lint.result == 'skipped') &&
      (needs.unit-tests.result == 'success' || needs.unit-tests.result == 'skipped') &&
      vars.ENABLE_BUNDLE == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Restore dependencies cache
        uses: actions/cache@v3
        with:
          path: |
            node_modules
            ~/.cache
            .cache
          key: ${{ runner.os }}-deps-${{ hashFiles('**/package*.json', '**/yarn.lock', '**/pnpm-lock.yaml') }}

      - name: Download build artifacts
        if: ${{ vars.ENABLE_COMPILE == 'true' }}
        uses: actions/download-artifact@v4
        with:
          name: build-output

      - name: Create bundle/package
        run: ./scripts/ci/build/ci-04-bundle.sh

      - name: Upload bundle artifacts
        uses: actions/upload-artifact@v4
        with:
          name: bundle-output
          path: |
            *.tgz
            *.tar.gz
            *.zip
            dist/
          retention-days: 30

  summary:
    name: Pipeline Summary
    runs-on: ubuntu-latest
    needs: [setup, compile, lint, unit-tests, integration-tests, e2e-tests, security-scan, bundle]
    if: always()
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Generate summary
        env:
          ENABLE_COMPILE: ${{ vars.ENABLE_COMPILE || 'false' }}
          ENABLE_LINT: ${{ vars.ENABLE_LINT || 'false' }}
          ENABLE_UNIT_TESTS: ${{ vars.ENABLE_UNIT_TESTS || 'false' }}
          ENABLE_INTEGRATION_TESTS: ${{ vars.ENABLE_INTEGRATION_TESTS || 'false' }}
          ENABLE_E2E_TESTS: ${{ vars.ENABLE_E2E_TESTS || 'false' }}
          ENABLE_SECURITY_SCAN: ${{ vars.ENABLE_SECURITY_SCAN || 'false' }}
          ENABLE_BUNDLE: ${{ vars.ENABLE_BUNDLE || 'false' }}
        run: |
          ./scripts/ci/build/ci-05-summary-pre-release.sh \
            "${{ needs.setup.result }}" \
            "${{ needs.compile.result }}" \
            "${{ needs.lint.result }}" \
            "${{ needs.unit-tests.result }}" \
            "${{ needs.integration-tests.result }}" \
            "${{ needs.e2e-tests.result }}" \
            "${{ needs.security-scan.result }}" \
            "${{ needs.bundle.result }}"

      - name: Check for failures
        run: |
          ./scripts/ci/build/ci-06-check-failures.sh \
            "${{ needs.setup.result }}" \
            "${{ needs.compile.result }}" \
            "${{ needs.lint.result }}" \
            "${{ needs.unit-tests.result }}" \
            "${{ needs.integration-tests.result }}" \
            "${{ needs.e2e-tests.result }}" \
            "${{ needs.security-scan.result }}" \
            "${{ needs.bundle.result }}"

  notify:
    name: Send Notifications
    runs-on: ubuntu-latest
    needs: [summary]
    if: always()
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check if notifications enabled
        id: check_notify
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          APPRISE_URLS: ${{ secrets.APPRISE_URLS }}
          ENABLE_NOTIFICATIONS: ${{ vars.ENABLE_NOTIFICATIONS }}
        run: ./scripts/ci/notification/check-notifications-enabled.sh

      - name: Determine pipeline status
        if: steps.check_notify.outputs.enabled == 'true'
        id: status
        env:
          GITHUB_RUN_NUMBER: ${{ github.run_number }}
          GITHUB_REF_NAME: ${{ github.ref_name }}
          GITHUB_SHA: ${{ github.sha }}
          GITHUB_ACTOR: ${{ github.actor }}
          GITHUB_SERVER_URL: ${{ github.server_url }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_RUN_ID: ${{ github.run_id }}
        run: ./scripts/ci/notification/ci-02-determine-status.sh "${{ needs.summary.result }}"

      - name: Send notification
        if: steps.check_notify.outputs.enabled == 'true'
        env:
          APPRISE_URLS: ${{ steps.check_notify.outputs.apprise_urls }}
        run: ./scripts/ci/notification/ci-01-send-notification.sh \
            "Pre-Release Pipeline" \
            "${{ steps.status.outputs.message }}" \
            "${{ steps.status.outputs.status }}"
