name: Pre-Release Pipeline

# Triggers for pre-release checks
on:
  pull_request:
    branches: [main]
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      enable_e2e:
        description: 'Enable E2E tests'
        required: false
        default: false
        type: boolean
      test_mode:
        description: 'Test mode override'
        required: false
        default: 'EXECUTE'
        type: choice
        options:
          - EXECUTE
          - DRY_RUN
          - PASS
          - FAIL
          - SKIP
          - TIMEOUT

# Environment variables
env:
  NODE_OPTIONS: '--max-old-space-size=4096'
  CI_TEST_MODE: ${{ inputs.test_mode || 'EXECUTE' }}

jobs:
  # Setup job - always runs
  setup:
    name: Setup Environment
    runs-on: ubuntu-latest
    timeout-minutes: ${{ vars.CI_JOB_TIMEOUT_MINUTES || 10 }}
    outputs:
      cache-hit: ${{ steps.cache-mise.outputs.cache-hit }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup MISE
        uses: jdx/mise-action@v2
        with:
          mise_toml: mise.toml
          install_missing: true

      - name: Cache MISE tools
        id: cache-mise
        uses: actions/cache@v4
        with:
          path: ~/.local/share/mise
          key: ${{ runner.os }}-mise-${{ hashFiles('mise.toml') }}
          restore-keys: |
            ${{ runner.os }}-mise-

      - name: Install dependencies
        run: mise run install-deps

      - name: Install project dependencies
        run: ./scripts/setup/10-ci-install-deps.sh

      - name: Validate environment
        run: ./scripts/setup/20-ci-validate-env.sh

      - name: Cache node modules
        if: hashFiles('package-lock.json') != ''
        uses: actions/cache@v4
        with:
          path: node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

  # Security scan job - always runs
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: setup
    timeout-minutes: ${{ vars.CI_JOB_TIMEOUT_MINUTES || 15 }}
    if: always() && needs.setup.result == 'success'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for secret scanning

      - name: Setup MISE
        uses: jdx/mise-action@v2
        with:
          mise_toml: mise.toml
          cache: true

      - name: Run Gitleaks scan
        run: |
          if command -v gitleaks >/dev/null 2>&1; then
            mise run scan-secrets > gitleaks-report.json 2>&1 || true
            echo "Gitleaks scan completed"
          else
            echo "Gitleaks not available, skipping"
          fi

      - name: Run Trufflehog scan
        run: |
          if command -v trufflehog >/dev/null 2>&1; then
            mise run scan-history > trufflehog-report.json 2>&1 || true
            echo "Trufflehog scan completed"
          else
            echo "Trufflehog not available, skipping"
          fi

      - name: Upload security scan results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-scan-results
          path: |
            gitleaks-report.json
            trufflehog-report.json
            npm-audit-report.json
          retention-days: 30

  # Notify job - always runs
  notify-pre-release:
    name: Pipeline Report
    runs-on: ubuntu-latest
    needs: [setup, security-scan]
    timeout-minutes: ${{ vars.CI_JOB_TIMEOUT_MINUTES || 10 }}
    if: always()
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup MISE
        uses: jdx/mise-action@v2
        with:
          mise_toml: mise.toml
          cache: true

      - name: Determine pipeline status
        id: status
        run: |
          STATUS="failure"
          if [[ "${{ needs.setup.result }}" == "success" ]]; then
            if [[ "${{ needs.security-scan.result }}" == "success" || "${{ needs.security-scan.result }}" == "skipped" ]]; then
              STATUS="success"
            fi
          fi
          echo "status=$STATUS" >> $GITHUB_OUTPUT

      - name: Generate pipeline report
        env:
          GITHUB_STEP_SUMMARY: ${{ github.workspace }}/pipeline-report.md
        run: |
          # Determine current version if available
          VERSION=""
          if git tag --points-at HEAD | grep -qE "v[0-9]+\.[0-9]+\.[0-9]+" 2>/dev/null; then
            VERSION=$(git tag --points-at HEAD | grep -E "v[0-9]+\.[0-9]+\.[0-9]+" | head -n1 | sed 's|.*/||')
          fi

          ./scripts/ci/report-generator.sh "${{ steps.status.outputs.status }}" "$VERSION"

      - name: Upload pipeline report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pipeline-report
          path: pipeline-report.md
          retention-days: 7

      - name: Send notifications
        if: vars.ENABLE_NOTIFICATIONS == 'true' && env.APPRISE_URL != ''
        run: |
          if command -v apprise >/dev/null 2>&1; then
            STATUS="${{ steps.status.outputs.status }}"
            WORKFLOW="${{ github.workflow }}"
            REPO="${{ github.repository }}"
            RUN_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

            MESSAGE="üöÄ Pipeline ${STATUS^}: ${WORKFLOW} in ${REPO}"
            if [[ "$STATUS" == "success" ]]; then
              apprise -t "‚úÖ $MESSAGE" -b "View details: $RUN_URL" "$APPRISE_URL"
            else
              apprise -t "‚ùå $MESSAGE" -b "View details: $RUN_URL" "$APPRISE_URL"
            fi
          else
            echo "Apprise not available or APPRISE_URL not set"
          fi
