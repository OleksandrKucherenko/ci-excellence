name: Post-Release Pipeline

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to rollback or tag'
        required: true
        type: string
      action:
        description: 'Post-release action'
        required: true
        type: choice
        options:
          - rollback
          - tag-stable
          - tag-unstable
          - verify-deployment

  release:
    types: [published]

env:
  ENABLE_ROLLBACK: ${{ vars.ENABLE_ROLLBACK || 'false' }}
  ENABLE_DEPLOYMENT_VERIFICATION: ${{ vars.ENABLE_DEPLOYMENT_VERIFICATION || 'false' }}
  ENABLE_STABILITY_TAGGING: ${{ vars.ENABLE_STABILITY_TAGGING || 'false' }}

jobs:
  verify-deployment:
    name: Verify Deployment
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'release' ||
      github.event.inputs.action == 'verify-deployment'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup environment
        run: ./scripts/ci/setup/ci-10-install-tools.sh

      - name: Determine version
        id: version
        run: ./scripts/ci/release/ci-05-select-version.sh \
          "${{ github.event_name }}" \
          "${{ github.event.release.tag_name }}" \
          "${{ github.event.inputs.version }}"

      - name: Verify NPM deployment
        if: vars.ENABLE_NPM_PUBLISH == 'true'
        run: ./scripts/ci/release/ci-70-verify-npm-deployment.sh "${{ steps.version.outputs.version }}"

      - name: Verify GitHub release
        if: vars.ENABLE_GITHUB_RELEASE == 'true'
        run: |
          ./scripts/ci/release/ci-35-verify-github-release.sh "${{ steps.version.outputs.version }}"

      - name: Verify Docker deployment
        if: vars.ENABLE_DOCKER_PUBLISH == 'true'
        run: |
          ./scripts/ci/release/ci-85-verify-docker-deployment.sh "${{ steps.version.outputs.version }}"

      - name: Run smoke tests
        run: ./scripts/ci/test/ci-40-smoke-tests.sh "${{ steps.version.outputs.version }}"

      - name: Report verification results
        if: always()
        run: ./scripts/ci/reports/ci-80-summary-post-release-verify.sh "${{ steps.version.outputs.version }}"

  tag-stable:
    name: Tag as Stable
    runs-on: ubuntu-latest
    if: |
      github.event.inputs.action == 'tag-stable' &&
      vars.ENABLE_STABILITY_TAGGING == 'true'
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Create stable tag
        run: ./scripts/ci/release/ci-07-apply-stability-tag.sh stable "${{ github.event.inputs.version }}"

  tag-unstable:
    name: Tag as Unstable
    runs-on: ubuntu-latest
    if: |
      github.event.inputs.action == 'tag-unstable' &&
      vars.ENABLE_STABILITY_TAGGING == 'true'
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Create unstable tag
        run: ./scripts/ci/release/ci-07-apply-stability-tag.sh unstable "${{ github.event.inputs.version }}"

  rollback:
    name: Rollback Release
    runs-on: ubuntu-latest
    if: |
      github.event.inputs.action == 'rollback' &&
      vars.ENABLE_ROLLBACK == 'true'
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup environment
        run: ./scripts/ci/setup/ci-10-install-tools.sh

      - name: Confirm rollback
        run: ./scripts/ci/release/ci-77-confirm-rollback.sh "${{ github.event.inputs.version }}"

      - name: Rollback NPM release
        if: vars.ENABLE_NPM_PUBLISH == 'true'
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: ./scripts/ci/release/ci-75-rollback-npm.sh "${{ github.event.inputs.version }}"

      - name: Update GitHub release
        if: vars.ENABLE_GITHUB_RELEASE == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ./scripts/ci/release/ci-40-rollback-github.sh "${{ github.event.inputs.version }}"

      - name: Tag Docker images as deprecated
        if: vars.ENABLE_DOCKER_PUBLISH == 'true'
        run: |
          ./scripts/ci/release/ci-90-rollback-docker.sh "${{ github.event.inputs.version }}"

      - name: Report rollback results
        run: ./scripts/ci/reports/ci-85-summary-rollback.sh "${{ github.event.inputs.version }}"

  notify:
    name: Notify Post-Release Actions
    runs-on: ubuntu-latest
    needs: [verify-deployment, tag-stable, tag-unstable, rollback]
    if: always()
    steps:
      - name: Generate summary
        run: |
          ./scripts/ci/reports/ci-90-summary-post-release.sh \
            "${{ needs['verify-deployment'].result }}" \
            "${{ needs['tag-stable'].result }}" \
            "${{ needs['tag-unstable'].result }}" \
            "${{ needs.rollback.result }}"

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check if notifications enabled
        id: check_notify
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          APPRISE_URLS: ${{ secrets.APPRISE_URLS }}
          ENABLE_NOTIFICATIONS: ${{ vars.ENABLE_NOTIFICATIONS }}
        run: ./scripts/ci/notification/ci-10-check-notifications-enabled.sh

      - name: Determine action type and status
        if: steps.check_notify.outputs.enabled == 'true'
        id: status
        run: |
          ./scripts/ci/notification/ci-50-post-release-status.sh \
            "${{ needs['verify-deployment'].result }}" \
            "${{ needs['tag-stable'].result }}" \
            "${{ needs['tag-unstable'].result }}" \
            "${{ needs.rollback.result }}"

      - name: Send notification
        if: steps.check_notify.outputs.enabled == 'true'
        env:
          APPRISE_URLS: ${{ steps.check_notify.outputs.apprise_urls }}
        run: ./scripts/ci/notification/ci-30-send-notification.sh \
            "Post-Release Pipeline" \
            "${{ steps.status.outputs.message }}" \
            "${{ steps.status.outputs.status }}"
