[settings]
experimental = true
verbose = false                             # enable if SOPS is failing or you need more debug details
sops.age_key_file = ".secrets/mise-age.txt"
sops.rops = false                           # use original SOPS binary not a rops library
sops.strict = false                         # if age key is not provided do not raise an ERROR

[[env]]
MISE_SOPS_AGE_KEY_FILE = ".secrets/mise-age.txt"
SOPS_AGE_KEY_FILE = "{{env.MISE_SOPS_AGE_KEY_FILE}}"

[[env]]
_.file = [".env.secrets.json", ".env"]

[tasks.setup]
description = "Pre-configure project folders"
run = ["./scripts/setup/00-setup-folders.sh"]

[tasks.install-hooks]
description = "Install git hooks with lefthook"
run = ["lefthook install"]

[tasks.uninstall-hooks]
description = "Uninstall git hooks"
run = ["lefthook uninstall"]

[tasks.scan-secrets]
description = "Scan repository for secrets with gitleaks"
run = ["gitleaks detect --redact --verbose --report-path gitleaks-report.json"]

[tasks.scan-history]
description = "Scan git history for leaked credentials with trufflehog"
run = ["trufflehog git file://. --only-verified"]

[tasks.encrypt-secrets]
description = "Encrypt secrets file with SOPS"
run = [
  "sops --encrypt --input-type json --output-type json config/.env.secrets.json.example > .env.secrets.json",
]

[tasks.decrypt-secrets]
description = "Decrypt secrets file with SOPS"
run = ["sops --decrypt .env.secrets.json"]

[tasks.edit-secrets]
description = "Edit encrypted secrets file"
run = ["sops .env.secrets.json"]

[tasks.generate-age-key]
description = "Generate new age key pair for secrets encryption"
run = ["./scripts/setup/generate-age-key.sh"]

[tasks.inject-secret]
description = "Inject or update a secret in .env.secrets.json (creates file if needed)"
run = ["./scripts/setup/inject-secret.sh \"$@\""]

[tasks.inject-gh-secret]
description = "Inject secrets from .env.secrets.json into GitHub Actions"
run = ["./scripts/setup/inject-gh-secret.sh \"$@\""]

[tasks.validate-workflows]
description = "Validate GitHub Actions workflows"
run = [
  "if [ -d .github/workflows ]; then",
  "  action-validator .github/workflows/*.yml .github/workflows/*.yaml 2>/dev/null || true",
  "else",
  "  echo 'No workflows found in .github/workflows'",
  "fi",
]

# Profile management tasks
[tasks.switch-profile]
description = "Switch MISE profile for environment context"
run = ["./scripts/profile/switch-profile.sh \"$@\""]

[tasks.profile-status]
description = "Show current profile status"
run = ["./scripts/profile/show-profile.sh"]

# Testing tasks
[tasks.test]
description = "Run all tests with ShellSpec"
run = ["shellspec"]

[tasks."test:watch"]
description = "Run tests in watch mode"
run = ["shellspec --watch"]

[tasks."test:coverage"]
description = "Run tests with coverage"
run = ["shellspec --format documentation --coverage"]

[tasks.lint]
description = "Lint all bash scripts with ShellCheck"
run = ["shellcheck **/*.sh"]

[tasks.format]
description = "Format all bash scripts with shfmt"
run = ["shfmt -l -w ."]

[tasks."format:check"]
description = "Check formatting without changing files"
run = ["shfmt -l ."]

[tasks.verify-tools]
description = "Verify all required tools are installed"
run = ["./scripts/tools/verify-tools.sh"]

[tasks."test:local-ci"]
description = "Run workflows locally with act in DRY_RUN mode"
run = ["act --dry-run"]

# Secret management tasks
[tasks.secrets-init]
description = "Initialize encrypted secrets for environment"
run = ["./scripts/secrets/init-secrets.sh \"$@\""]

[tasks.secrets-rotate]
description = "Rotate encryption keys"
run = ["./scripts/secrets/rotate-keys.sh"]

[tasks.decrypt-staging]
description = "Decrypt staging environment secrets"
run = ["sops --decrypt environments/staging/secrets.enc"]

[tasks.decrypt-production]
description = "Decrypt production environment secrets"
run = ["sops --decrypt environments/production/secrets.enc"]

[tasks.decrypt-global]
description = "Decrypt global secrets"
run = ["sops --decrypt environments/global/secrets.enc"]

[tasks.encrypt-staging]
description = "Encrypt staging environment secrets"
run = ["sops --encrypt environments/staging/secrets.enc"]

[tasks.encrypt-production]
description = "Encrypt production environment secrets"
run = ["sops --encrypt environments/production/secrets.enc"]

[tasks.encrypt-global]
description = "Encrypt global secrets"
run = ["sops --encrypt environments/global/secrets.enc"]

# Setup tasks
[tasks.dev-setup]
description = "Setup development environment"
run = [
  "mise install",
  "./scripts/tools/setup-platform.sh",
  "mkdir -p .secrets",
  "mise run install-hooks",
]


[tasks.claude-zai]
description = "ü§ñ Launch Claude CLI with z.ai configuration"
run = """
#!/bin/bash
set -e

echo "üöÄ Launching Claude CLI with z.ai configuration..."

# Check if ZAI_AUTH_TOKEN is set
if [[ -z "$ZAI_AUTH_TOKEN" ]]; then
  echo "‚ùå ZAI_AUTH_TOKEN environment variable is not set!"
  echo ""
  echo "üí° To fix this:"
  echo "   1. Add ZAI_AUTH_TOKEN to your .env file"
  echo "   2. Or export it manually: export ZAI_AUTH_TOKEN=\"your-token-here\""
  echo "   3. Or add it to .env.secrets.json using: mise run secrets-edit"
  echo ""
  exit 1
fi

# Set environment variables for z.ai (these override ~/.claude/settings.json)
export ANTHROPIC_AUTH_TOKEN="$ZAI_AUTH_TOKEN"
export ANTHROPIC_BASE_URL="https://api.z.ai/api/anthropic"
export API_TIMEOUT_MS="3000000"
export ANTHROPIC_DEFAULT_HAIKU_MODEL="glm-4.5-air"
export ANTHROPIC_DEFAULT_SONNET_MODEL="glm-4.6"
export ANTHROPIC_DEFAULT_OPUS_MODEL="glm-4.6"

echo "‚úÖ Environment configured for z.ai"
echo "üîó Base URL: $ANTHROPIC_BASE_URL"
echo "ü§ñ Models: Haiku=$ANTHROPIC_DEFAULT_HAIKU_MODEL, Sonnet=$ANTHROPIC_DEFAULT_SONNET_MODEL, Opus=$ANTHROPIC_DEFAULT_OPUS_MODEL"
echo "üîë Token: ${ANTHROPIC_AUTH_TOKEN:0:20}..."
echo ""

# Launch Claude CLI with the configured environment
exec claude --dangerously-skip-permissions
"""

[hooks]
enter = ["mise run setup", "mise run install-hooks"]

[tools]
# Core runtime
bun = "latest"
node = "20"

# Security and encryption
age = "latest"
sops = "latest"
gitleaks = "latest"
trufflehog = "latest"

# Git hooks and commit management
lefthook = "latest"
# commitizen = "latest"  # Disabled - not in mise registry

# Shell development and testing
shellspec = "latest"
shellcheck = "latest"
shfmt = "latest"

# Local CI testing
act = "latest"

# GitHub Actions validation
action-validator = "latest"

# Notifications
"pipx:apprise" = "latest"
