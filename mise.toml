[settings]
experimental = true
verbose = false                             # enable if SOPS is failing or you need more debug details
sops.age_key_file = ".secrets/mise-age.txt"
sops.rops = false                           # use original SOPS binary not a rops library
sops.strict = false                         # if age key is not provided do not raise an ERROR

[[env]]
MISE_SOPS_AGE_KEY_FILE = ".secrets/mise-age.txt"
SOPS_AGE_KEY_FILE = "{{env.MISE_SOPS_AGE_KEY_FILE}}"

[[env]]
_.file = [".env.secrets.json", ".env"]

[tasks.setup]
description = "Pre-configure project folders"
run = ["./scripts/setup/00-setup-folders.sh"]

[tasks.install-hooks]
description = "Install git hooks with lefthook"
run = ["lefthook install"]

[tasks.uninstall-hooks]
description = "Uninstall git hooks"
run = ["lefthook uninstall"]

[tasks.scan-secrets]
description = "Scan repository for secrets with gitleaks"
run = ["gitleaks detect --redact --verbose --report-path gitleaks-report.json"]

[tasks.scan-history]
description = "Scan git history for leaked credentials with trufflehog"
run = ["trufflehog git file://. --only-verified"]

[tasks.encrypt-secrets]
description = "Encrypt secrets file with SOPS"
run = ["sops --encrypt --age $(cat .secrets/mise-age-pub.txt) .env.secrets.json.example > .env.secrets.json"]

[tasks.decrypt-secrets]
description = "Decrypt secrets file with SOPS"
run = ["sops --decrypt .env.secrets.json"]

[tasks.edit-secrets]
description = "Edit encrypted secrets file"
run = ["sops .env.secrets.json"]

[tasks.generate-age-key]
description = "Generate new age key pair for secrets encryption"
run = ["./scripts/setup/generate-age-key.sh"]

[tasks.validate-workflows]
description = "Validate GitHub Actions workflows"
run = [
  "if [ -d .github/workflows ]; then",
  "  action-validator .github/workflows/*.yml .github/workflows/*.yaml 2>/dev/null || true",
  "else",
  "  echo 'No workflows found in .github/workflows'",
  "fi"
]

[hooks]
enter = ["mise run setup", "mise run install-hooks"]

[tools]
age = "latest"
sops = "latest"
# Secret detection tools
gitleaks = "latest"
trufflehog = "latest"
# Git hooks manager
lefthook = "latest"
# GitHub Actions validator
action-validator = "latest"
# Notification tool
"uv:apprise" = "latest"
